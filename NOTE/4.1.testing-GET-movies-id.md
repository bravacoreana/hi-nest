# 4.1 Testing GET movies id

## 테스팅 시 흔하게 겪는 에러 핸들링하기

**테스트에서도 실제 앱 환경을 그대로 적용시켜줘야 함**

우리가 테스트를 할 때마다 NestJ가 각 테스트를 위한 앱을 생성함

```ts
describe("AppController (e2e)", () => {
  let app: INestApplication;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });
  //...
});
```

따라서, 브라우저에서 테스트 할 수 있는 진짜 앱(`npm run start:dev` 했을 때 실행되는 거) + 각 테스트 위한 앱은 다름!!

그러나 우리는 매번 테스트할 때마다 앱이 생성되는 것을 원하지 않음. 따라서 테스팅 시작 전에 앱을 만든다. 예를 들어, 내가 createMovie 테스트를 할 때 생성한 영화가 계속 데이터로 남아있었으면 좋겠음. 매번 테스트할 때마다 앱이 생성된다면 db는 계속 비워지게 됨.

```ts
describe("AppController (e2e)", () => {
  let app: INestApplication;

  // beforeEach -> beforeAll
  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });
});
```

```ts
describe("AppController (e2e)", () => {
  //...
  describe("/movies", () => {
    it("GET", () => {
      return request(app.getHttpServer()).get("/movies").expect(200).expect([]);
    });
    //...
    describe("/movies/:id", () => {
      it("GET 200", () => {
        return request(app.getHttpServer()).get("/movies/1").expect(200);
      });
    });
  });
});
```

이렇게만 하면 에러가 난다, why? id의 타입이 다름! 왜 다를까? 실제 앱에서는 pipe를 사용해 타입 자동전환을 허락(`transform:true`) 했었음. 하지만 테스팅 환경에서는 아님! 따라서 똑같이 파이프를 추가해준다!

```ts
describe("AppController (e2e)", () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    // 파이프를 추가해줘야 에러가 나지 않는다!
    app.useGlobalPipes(
      new ValidationPipe({
        whitelist: true,
        forbidNonWhitelisted: true,
        transform: true,
      })
    );
    await app.init();
  });
  //...
});
```
